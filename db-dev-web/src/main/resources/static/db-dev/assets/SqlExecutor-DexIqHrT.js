import{r as E,_ as xe,x as Se,A as g,B as t,m as h,K as w,C as s,ay as r,aI as be,o as u,D as a,P as R,M as p,O as f,ac as T,u as Ce,J as ke,F as Le,Y as Ee}from"./vue-vendor-BB5k324P.js";import{u as De}from"./datasource-BB4_IJ-g.js";import{r as Ve}from"./request-CcLfhpZL.js";import{_ as Ne}from"./index-C9u0Vdbf.js";import{b as m}from"./element-plus-DuTa5cwT.js";import"./datasource-CNDQnR3F.js";import"./vendor-BTz0EEYM.js";const Re=H=>Ve({url:"/sql/execute",method:"post",data:H}),qe={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Oe={style:{display:"flex","align-items":"center",gap:"8px"}},ze={style:{display:"flex",gap:"8px"}},Ie={style:{display:"flex","align-items":"center",gap:"8px"}},Me={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Te={style:{display:"flex","align-items":"center","justify-content":"space-between"}},He={style:{display:"flex","align-items":"center",gap:"8px"}},Ue={style:{display:"flex","flex-direction":"column",gap:"4px"}},Qe={style:{"font-weight":"100"}},We={style:{display:"flex","align-items":"center",gap:"6px"}},Be={style:{display:"flex","align-items":"center",gap:"8px"}},$e={style:{color:"#f56c6c","font-family":"'Courier New', monospace",padding:"10px",background:"#fef0f0","border-radius":"4px"}},je={style:{display:"flex","justify-content":"space-between"}},Fe={style:{display:"flex","align-items":"center","justify-content":"space-between",width:"100%"}},Je={style:{display:"flex","align-items":"center",gap:"8px"}},Ye={key:0,style:{"text-align":"center",padding:"40px",color:"#909399"}},Ae={key:1,class:"history-list"},Ge=["onClick"],Pe={class:"history-header"},Ke={style:{display:"flex","align-items":"center",gap:"8px"}},Xe={style:{display:"flex","align-items":"center",gap:"8px"}},Ze={class:"history-time"},et={class:"history-sql"},tt={key:0,class:"history-result"},lt={key:1,class:"history-error"},j="sql_executor_history",F=100,st={__name:"SqlExecutor",setup(H){const q=De(),x=E(""),v=E(""),i=E(null),V=E(!1),_=xe({visible:!1,title:"",content:"",type:""}),N=E(!1),d=E([]),J=()=>{try{const l=localStorage.getItem(j);l&&(d.value=JSON.parse(l))}catch(l){console.error("加载历史记录失败:",l),d.value=[]}},O=()=>{try{localStorage.setItem(j,JSON.stringify(d.value))}catch(l){console.error("保存历史记录失败:",l)}},U=(l,e,y,n,S)=>{const b=d.value.findIndex(k=>k.sql.trim()===l.trim()&&k.dataSource===e);b!==-1&&d.value.splice(b,1);const D={id:Date.now(),sql:l,dataSource:e,success:y,rowCount:n,errorMessage:S,timestamp:new Date().toISOString()};d.value.unshift(D),d.value.length>F&&(d.value=d.value.slice(0,F)),O()},Y=l=>{d.value.splice(l,1),O(),m.success("已删除该条记录")},A=()=>{d.value=[],O(),m.success("历史记录已清空")},G=l=>{v.value=l.sql,x.value=l.dataSource,N.value=!1,m.success("已加载历史SQL")},P=l=>{const e=new Date(l),n=new Date-e;return n<6e4?"刚刚":n<36e5?`${Math.floor(n/6e4)} 分钟前`:n<864e5?`${Math.floor(n/36e5)} 小时前`:e.toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},K=l=>{const e=l.trim().replace(/\s+/g," ");return e.length>100?e.substring(0,100)+"...":e},X=l=>l.length>80?l.substring(0,80)+"...":l,Z=async()=>{if(!x.value||!v.value.trim()){m.warning("请选择数据源并输入SQL语句");return}V.value=!0;try{const l=await Re({dataSourceName:x.value,sql:v.value.trim(),params:[]});i.value={success:!0,columns:l.data.columns,data:l.data.data,rowCount:l.data.rowCount||0,hasMore:l.data.hasMore},U(v.value.trim(),x.value,!0,l.data.rowCount,null),m.success("SQL执行成功")}catch(l){i.value={success:!1,message:l.message},U(v.value.trim(),x.value,!1,null,l.message),m.error("SQL执行失败")}finally{V.value=!1}},ee=()=>{v.value="",i.value=null,m.info("已清空SQL")},te=()=>{if(!v.value.trim()){m.warning("请先输入SQL语句");return}try{let l=v.value.trim();l=l.replace(/\b(SELECT|FROM|WHERE|ORDER BY|GROUP BY|HAVING|JOIN|LEFT JOIN|RIGHT JOIN|INNER JOIN)\b/gi,`
$1`),l=l.replace(/\n\s*\n/g,`
`);let e=l.split(`
`),y=0;e=e.map(n=>{if(n=n.trim(),!n)return"";(n.startsWith("FROM")||n.startsWith("WHERE")||n.startsWith("ORDER BY")||n.startsWith("GROUP BY")||n.startsWith("HAVING"))&&(y=Math.max(0,y-1));const S="  ".repeat(y)+n;return(n.startsWith("SELECT")||n.startsWith("FROM")||n.startsWith("WHERE")||n.includes("JOIN"))&&y++,S}),v.value=e.filter(n=>n!=="").join(`
`),m.success("SQL格式化完成")}catch{m.warning("格式化失败，请检查SQL语法")}},le=()=>{if(!i.value||!i.value.success){m.warning("没有可导出的查询结果");return}try{let l="";const e=i.value.columns.map(b=>b.name);l+=e.join(",")+`
`,i.value.data.forEach(b=>{const D=e.map(k=>{const c=b[k];return c==null?"NULL":typeof c=="string"&&(c.includes(",")||c.includes(`
`)||c.includes('"'))?'"'+c.replace(/"/g,'""')+'"':String(c)});l+=D.join(",")+`
`});const y=new Blob(["\uFEFF"+l],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),S=URL.createObjectURL(y);n.href=S,n.download=`query_result_${new Date().getTime()}.csv`,n.click(),URL.revokeObjectURL(S),m.success("导出成功")}catch(l){m.error("导出失败: "+l.message)}},se=l=>{if(l==null)return"NULL";const e=String(l);return e.length>50?e.substring(0,50)+"...":e},ne=l=>{if(l==null)return!1;const e=String(l);return e.length>50||e.includes(`
`)},oe=(l,e,y)=>{_.title=`查看字段: ${l}`,_.content=e==null?"NULL":String(e),_.type=y,_.visible=!0},ae=()=>{navigator.clipboard.writeText(_.content).then(()=>{m.success("数据已复制到剪贴板")}).catch(()=>{m.error("复制失败")})};return Se(async()=>{q.dataSources.length===0&&await q.loadDataSources(),J()}),(l,e)=>{const y=r("Lightning"),n=r("el-icon"),S=r("Star"),b=r("el-option"),D=r("el-select"),k=r("CaretRight"),c=r("el-button"),z=r("Delete"),Q=r("Clock"),re=r("el-badge"),I=r("el-alert"),W=r("el-input"),ie=r("SuccessFilled"),C=r("el-tag"),ue=r("Warning"),ce=r("MagicStick"),de=r("el-button-group"),M=r("el-card"),B=r("Document"),pe=r("Download"),fe=r("View"),me=r("el-table-column"),_e=r("el-table"),ye=r("CircleCloseFilled"),ve=r("DocumentCopy"),ge=r("el-dialog"),he=r("el-drawer"),we=be("loading");return u(),g("div",null,[t(M,{shadow:"hover",style:{"margin-bottom":"20px"}},{header:s(()=>[a("div",qe,[a("div",Oe,[t(n,null,{default:s(()=>[t(y)]),_:1}),e[7]||(e[7]=a("span",{style:{"font-weight":"600"}},"SQL 执行器",-1))]),a("div",ze,[t(D,{modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=o=>x.value=o),placeholder:"选择数据源",style:{width:"200px"},clearable:""},{default:s(()=>[(u(!0),g(R,null,T(Ce(q).dataSources,o=>(u(),h(b,{key:o.name,label:o.name,value:o.name},{default:s(()=>[a("div",Ie,[o.primary?(u(),h(n,{key:0,color:"#f56c6c"},{default:s(()=>[t(S)]),_:1})):w("",!0),a("span",null,f(o.name),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"]),t(c,{type:"primary",onClick:Z,loading:V.value,disabled:!x.value||!v.value},{default:s(()=>[t(n,null,{default:s(()=>[t(k)]),_:1}),e[8]||(e[8]=p(" 执行 ",-1))]),_:1},8,["loading","disabled"]),t(c,{onClick:ee},{default:s(()=>[t(n,null,{default:s(()=>[t(z)]),_:1}),e[9]||(e[9]=p(" 清空 ",-1))]),_:1}),t(c,{onClick:e[1]||(e[1]=o=>N.value=!0)},{default:s(()=>[t(n,null,{default:s(()=>[t(Q)]),_:1}),e[10]||(e[10]=p(" 历史记录 ",-1)),d.value.length>0?(u(),h(re,{key:0,value:d.value.length,max:99,style:{"margin-left":"6px"}},null,8,["value"])):w("",!0)]),_:1})])])]),default:s(()=>[t(I,{title:"仅支持SELECT查询语句",type:"warning",description:"为了安全考虑，SQL执行器只允许执行查询语句，不支持INSERT、UPDATE、DELETE等修改操作",closable:!1,"show-icon":"",style:{"margin-bottom":"15px"}}),t(W,{modelValue:v.value,"onUpdate:modelValue":e[2]||(e[2]=o=>v.value=o),type:"textarea",rows:8,placeholder:"请输入SELECT查询语句...",style:{"margin-bottom":"15px","font-family":"'Courier New', monospace"},resize:"none"},null,8,["modelValue"]),a("div",Me,[a("div",null,[i.value&&i.value.success?(u(),g(R,{key:0},[t(C,{type:"success",size:"small"},{default:s(()=>[t(n,null,{default:s(()=>[t(ie)]),_:1})]),_:1}),e[12]||(e[12]=p("  ",-1)),a("span",null,"查询成功: "+f(i.value.rowCount)+" 行数据",1),i.value.hasMore?(u(),h(C,{key:0,type:"warning",size:"small",style:{"margin-left":"8px"}},{default:s(()=>[t(n,null,{default:s(()=>[t(ue)]),_:1}),e[11]||(e[11]=p(" 数据已截断(最多显示1000行) ",-1))]),_:1})):w("",!0)],64)):w("",!0)]),t(de,null,{default:s(()=>[t(c,{size:"small",onClick:te},{default:s(()=>[t(n,null,{default:s(()=>[t(ce)]),_:1}),e[13]||(e[13]=p(" 格式化 ",-1))]),_:1})]),_:1})])]),_:1}),i.value&&i.value.success?(u(),h(M,{key:0,shadow:"hover"},{header:s(()=>[a("div",Te,[a("div",He,[t(n,null,{default:s(()=>[t(B)]),_:1}),e[14]||(e[14]=a("span",{style:{"font-weight":"600"}},"查询结果",-1)),t(C,{type:"success",size:"small"},{default:s(()=>[p(f(i.value.rowCount)+" 行",1)]),_:1}),i.value.columns?(u(),h(C,{key:0,type:"info",size:"small"},{default:s(()=>[p(f(i.value.columns.length)+" 列",1)]),_:1})):w("",!0)]),t(c,{type:"primary",size:"small",onClick:le},{default:s(()=>[t(n,null,{default:s(()=>[t(pe)]),_:1}),e[15]||(e[15]=p(" 导出结果 ",-1))]),_:1})])]),default:s(()=>[ke((u(),h(_e,{data:i.value.data,stripe:"",border:"",style:{width:"100%"},height:"500"},{default:s(()=>[(u(!0),g(R,null,T(i.value.columns,o=>(u(),h(me,{key:o.name,prop:o.name,label:o.name,width:"200","show-overflow-tooltip":""},{header:s(()=>[a("div",Ue,[a("span",Qe,f(o.name),1),t(C,{size:"small",type:"info",style:{"font-size":"10px"}},{default:s(()=>[p(f(o.type),1)]),_:2},1024)])]),default:s(L=>[a("div",We,[a("span",{style:{"font-family":"'Courier New', monospace","font-size":"12px",flex:"1"},class:Le({"null-value":L.row[o.name]===null})},f(se(L.row[o.name])),3),ne(L.row[o.name])?(u(),h(c,{key:0,type:"primary",size:"small",text:"",onClick:$=>oe(o.name,L.row[o.name],o.type)},{default:s(()=>[t(n,{size:"14"},{default:s(()=>[t(fe)]),_:1})]),_:1},8,["onClick"])):w("",!0)])]),_:2},1032,["prop","label"]))),128))]),_:1},8,["data"])),[[we,V.value]])]),_:1})):w("",!0),i.value&&!i.value.success?(u(),h(M,{key:1,shadow:"hover",style:{"border-left":"4px solid #f56c6c"}},{header:s(()=>[a("div",Be,[t(n,{color:"#f56c6c"},{default:s(()=>[t(ye)]),_:1}),e[16]||(e[16]=a("span",{style:{"font-weight":"600",color:"#f56c6c"}},"执行错误",-1))])]),default:s(()=>[a("div",$e,f(i.value.message),1)]),_:1})):w("",!0),t(ge,{modelValue:_.visible,"onUpdate:modelValue":e[5]||(e[5]=o=>_.visible=o),title:_.title,width:"600px"},{footer:s(()=>[a("div",je,[t(C,{size:"small"},{default:s(()=>[p("长度: "+f(_.content?.length||0)+" 字符",1)]),_:1}),a("div",null,[t(c,{onClick:ae},{default:s(()=>[t(n,null,{default:s(()=>[t(ve)]),_:1}),e[17]||(e[17]=p(" 复制 ",-1))]),_:1}),t(c,{type:"primary",onClick:e[4]||(e[4]=o=>_.visible=!1)},{default:s(()=>[...e[18]||(e[18]=[p("关闭",-1)])]),_:1})])])]),default:s(()=>[t(I,{title:`数据类型: ${_.type}`,type:"info",closable:!1,style:{"margin-bottom":"15px"}},null,8,["title"]),t(W,{modelValue:_.content,"onUpdate:modelValue":e[3]||(e[3]=o=>_.content=o),type:"textarea",rows:15,readonly:"",style:{"font-family":"'Courier New', monospace"}},null,8,["modelValue"])]),_:1},8,["modelValue","title"]),t(he,{modelValue:N.value,"onUpdate:modelValue":e[6]||(e[6]=o=>N.value=o),title:"SQL 执行历史",direction:"rtl",size:"500px"},{header:s(()=>[a("div",Fe,[a("div",Je,[t(n,null,{default:s(()=>[t(Q)]),_:1}),e[19]||(e[19]=a("span",{style:{"font-weight":"600"}},"SQL 执行历史",-1))]),t(c,{type:"danger",size:"small",text:"",onClick:A,disabled:d.value.length===0},{default:s(()=>[t(n,null,{default:s(()=>[t(z)]),_:1}),e[20]||(e[20]=p(" 清空历史 ",-1))]),_:1},8,["disabled"])])]),default:s(()=>[t(I,{title:"历史记录存储在本地浏览器中，最多保留100条记录",type:"info",closable:!1,"show-icon":"",style:{"margin-bottom":"15px"}}),d.value.length===0?(u(),g("div",Ye,[t(n,{size:"48"},{default:s(()=>[t(B)]),_:1}),e[21]||(e[21]=a("p",null,"暂无执行历史",-1))])):(u(),g("div",Ae,[(u(!0),g(R,null,T(d.value,(o,L)=>(u(),g("div",{key:o.id,class:"history-item",onClick:$=>G(o)},[a("div",Pe,[a("div",Ke,[t(C,{type:o.success?"success":"danger",size:"small"},{default:s(()=>[p(f(o.success?"成功":"失败"),1)]),_:2},1032,["type"]),t(C,{type:"info",size:"small"},{default:s(()=>[p(f(o.dataSource),1)]),_:2},1024)]),a("div",Xe,[a("span",Ze,f(P(o.timestamp)),1),t(c,{type:"danger",size:"small",text:"",onClick:Ee($=>Y(L),["stop"])},{default:s(()=>[t(n,null,{default:s(()=>[t(z)]),_:1})]),_:1},8,["onClick"])])]),a("div",et,f(K(o.sql)),1),o.success&&o.rowCount!==void 0?(u(),g("div",tt," 返回 "+f(o.rowCount)+" 行数据 ",1)):w("",!0),!o.success&&o.errorMessage?(u(),g("div",lt,f(X(o.errorMessage)),1)):w("",!0)],8,Ge))),128))]))]),_:1},8,["modelValue"])])}}},dt=Ne(st,[["__scopeId","data-v-92f28990"]]);export{dt as default};
