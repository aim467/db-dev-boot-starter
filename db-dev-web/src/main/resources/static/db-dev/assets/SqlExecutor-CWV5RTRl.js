import{r as oe,u as ae}from"./datasource-CGHvgTzV.js";import{_ as se}from"./index-B8Sf_DuM.js";import{a as p}from"./element-plus-Cxi87m0O.js";import{r as L,_ as re,x as ie,A as R,B as t,m as _,K as v,C as l,ay as s,aI as ue,o as d,D as i,O as g,M as m,P as O,ac as U,u as ce,J as de,F as pe}from"./vue-vendor-yGlHWbnf.js";import"./vendor-BTz0EEYM.js";const me=N=>oe({url:"/sql/execute",method:"post",data:N}),fe={style:{display:"flex","align-items":"center","justify-content":"space-between"}},_e={style:{display:"flex","align-items":"center",gap:"8px"}},ye={style:{display:"flex",gap:"8px"}},ge={style:{display:"flex","align-items":"center",gap:"8px"}},ve={style:{display:"flex","justify-content":"space-between","align-items":"center"}},we={style:{"font-weight":"600"}},xe={style:{display:"flex","align-items":"center","justify-content":"space-between"}},he={style:{display:"flex","align-items":"center",gap:"8px"}},be={style:{display:"flex","flex-direction":"column",gap:"4px"}},Se={style:{"font-weight":"600","font-size":"12px"}},Ce={style:{display:"flex","align-items":"center",gap:"6px"}},Le={style:{display:"flex","align-items":"center",gap:"8px"}},Ee={style:{color:"#f56c6c","font-family":"'Courier New', monospace",padding:"10px",background:"#fef0f0","border-radius":"4px"}},ke={style:{display:"flex","justify-content":"space-between"}},De={__name:"SqlExecutor",setup(N){const E=ae(),h=L(""),y=L(""),r=L(null),S=L(!1),c=re({visible:!1,title:"",content:"",type:""}),T=async()=>{if(!h.value||!y.value.trim()){p.warning("请选择数据源并输入SQL语句");return}S.value=!0;try{const o=await me({dataSourceName:h.value,sql:y.value.trim(),params:[]});r.value={success:!0,columns:o.data.columns,data:o.data.data,rowCount:o.data.rowCount,hasMore:o.data.hasMore},p.success("SQL执行成功")}catch(o){r.value={success:!1,message:o.message},p.error("SQL执行失败")}finally{S.value=!1}},W=()=>{y.value="",r.value=null,p.info("已清空SQL")},I=()=>{if(!y.value.trim()){p.warning("请先输入SQL语句");return}try{let o=y.value.trim();o=o.replace(/\b(SELECT|FROM|WHERE|ORDER BY|GROUP BY|HAVING|JOIN|LEFT JOIN|RIGHT JOIN|INNER JOIN)\b/gi,`
$1`),o=o.replace(/\n\s*\n/g,`
`);let e=o.split(`
`),f=0;e=e.map(n=>{if(n=n.trim(),!n)return"";(n.startsWith("FROM")||n.startsWith("WHERE")||n.startsWith("ORDER BY")||n.startsWith("GROUP BY")||n.startsWith("HAVING"))&&(f=Math.max(0,f-1));const w="  ".repeat(f)+n;return(n.startsWith("SELECT")||n.startsWith("FROM")||n.startsWith("WHERE")||n.includes("JOIN"))&&f++,w}),y.value=e.filter(n=>n!=="").join(`
`),p.success("SQL格式化完成")}catch{p.warning("格式化失败，请检查SQL语法")}},M=()=>{if(!r.value||!r.value.success){p.warning("没有可导出的查询结果");return}try{let o="";const e=r.value.columns.map(b=>b.name);o+=e.join(",")+`
`,r.value.data.forEach(b=>{const k=e.map(D=>{const u=b[D];return u==null?"NULL":typeof u=="string"&&(u.includes(",")||u.includes(`
`)||u.includes('"'))?'"'+u.replace(/"/g,'""')+'"':String(u)});o+=k.join(",")+`
`});const f=new Blob(["\uFEFF"+o],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),w=URL.createObjectURL(f);n.href=w,n.download=`query_result_${new Date().getTime()}.csv`,n.click(),URL.revokeObjectURL(w),p.success("导出成功")}catch(o){p.error("导出失败: "+o.message)}},B=o=>{if(o==null)return"NULL";const e=String(o);return e.length>50?e.substring(0,50)+"...":e},F=o=>{if(o==null)return!1;const e=String(o);return e.length>50||e.includes(`
`)},Q=(o,e,f)=>{c.title=`查看字段: ${o}`,c.content=e==null?"NULL":String(e),c.type=f,c.visible=!0},j=()=>{navigator.clipboard.writeText(c.content).then(()=>{p.success("数据已复制到剪贴板")}).catch(()=>{p.error("复制失败")})};return ie(async()=>{E.dataSources.length===0&&await E.loadDataSources()}),(o,e)=>{const f=s("Lightning"),n=s("el-icon"),w=s("Star"),b=s("el-option"),k=s("el-select"),D=s("CaretRight"),u=s("el-button"),H=s("Delete"),q=s("el-alert"),z=s("el-input"),J=s("SuccessFilled"),x=s("el-tag"),$=s("Warning"),G=s("MagicStick"),A=s("el-button-group"),V=s("el-card"),P=s("Document"),Y=s("Download"),K=s("View"),X=s("el-table-column"),Z=s("el-table"),ee=s("CircleCloseFilled"),te=s("DocumentCopy"),le=s("el-dialog"),ne=ue("loading");return d(),R("div",null,[t(V,{shadow:"hover",style:{"margin-bottom":"20px"}},{header:l(()=>[i("div",fe,[i("div",_e,[t(n,null,{default:l(()=>[t(f)]),_:1}),e[5]||(e[5]=i("span",{style:{"font-weight":"600"}},"SQL 执行器",-1))]),i("div",ye,[t(k,{modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=a=>h.value=a),placeholder:"选择数据源",style:{width:"200px"},clearable:""},{default:l(()=>[(d(!0),R(O,null,U(ce(E).dataSources,a=>(d(),_(b,{key:a.name,label:a.name,value:a.name},{default:l(()=>[i("div",ge,[a.primary?(d(),_(n,{key:0,color:"#f56c6c"},{default:l(()=>[t(w)]),_:1})):v("",!0),i("span",null,g(a.name),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"]),t(u,{type:"primary",onClick:T,loading:S.value,disabled:!h.value||!y.value},{default:l(()=>[t(n,null,{default:l(()=>[t(D)]),_:1}),e[6]||(e[6]=m(" 执行 ",-1))]),_:1},8,["loading","disabled"]),t(u,{onClick:W},{default:l(()=>[t(n,null,{default:l(()=>[t(H)]),_:1}),e[7]||(e[7]=m(" 清空 ",-1))]),_:1})])])]),default:l(()=>[t(q,{title:"仅支持SELECT查询语句",type:"warning",description:"为了安全考虑，SQL执行器只允许执行查询语句，不支持INSERT、UPDATE、DELETE等修改操作",closable:!1,"show-icon":"",style:{"margin-bottom":"15px"}}),t(z,{modelValue:y.value,"onUpdate:modelValue":e[1]||(e[1]=a=>y.value=a),type:"textarea",rows:8,placeholder:"请输入SELECT查询语句...",style:{"margin-bottom":"15px","font-family":"'Courier New', monospace"},resize:"none"},null,8,["modelValue"]),i("div",ve,[i("div",null,[r.value?(d(),_(x,{key:0,type:"success",size:"small"},{default:l(()=>[t(n,null,{default:l(()=>[t(J)]),_:1}),i("span",we,"查询成功: "+g(r.value.rowCount)+" 行数据",1)]),_:1})):v("",!0),r.value&&r.value.hasMore?(d(),_(x,{key:1,type:"warning",size:"small",style:{"margin-left":"8px"}},{default:l(()=>[t(n,null,{default:l(()=>[t($)]),_:1}),e[8]||(e[8]=m(" 数据已截断(最多显示1000行) ",-1))]),_:1})):v("",!0)]),t(A,null,{default:l(()=>[t(u,{size:"small",onClick:I},{default:l(()=>[t(n,null,{default:l(()=>[t(G)]),_:1}),e[9]||(e[9]=m(" 格式化 ",-1))]),_:1})]),_:1})])]),_:1}),r.value&&r.value.success?(d(),_(V,{key:0,shadow:"hover"},{header:l(()=>[i("div",xe,[i("div",he,[t(n,null,{default:l(()=>[t(P)]),_:1}),e[10]||(e[10]=i("span",{style:{"font-weight":"600"}},"查询结果",-1)),t(x,{type:"success",size:"small"},{default:l(()=>[m(g(r.value.rowCount)+" 行",1)]),_:1}),r.value.columns?(d(),_(x,{key:0,type:"info",size:"small"},{default:l(()=>[m(g(r.value.columns.length)+" 列",1)]),_:1})):v("",!0)]),t(u,{type:"primary",size:"small",onClick:M},{default:l(()=>[t(n,null,{default:l(()=>[t(Y)]),_:1}),e[11]||(e[11]=m(" 导出结果 ",-1))]),_:1})])]),default:l(()=>[de((d(),_(Z,{data:r.value.data,stripe:"",border:"",style:{width:"100%"},height:"500"},{default:l(()=>[(d(!0),R(O,null,U(r.value.columns,a=>(d(),_(X,{key:a.name,prop:a.name,label:a.name,width:"200","show-overflow-tooltip":""},{header:l(()=>[i("div",be,[i("span",Se,g(a.name),1),t(x,{size:"small",type:"info",style:{"font-size":"10px"}},{default:l(()=>[m(g(a.type),1)]),_:2},1024)])]),default:l(C=>[i("div",Ce,[i("span",{style:{"font-family":"'Courier New', monospace","font-size":"12px",flex:"1"},class:pe({"null-value":C.row[a.name]===null})},g(B(C.row[a.name])),3),F(C.row[a.name])?(d(),_(u,{key:0,type:"primary",size:"small",text:"",onClick:Ve=>Q(a.name,C.row[a.name],a.type)},{default:l(()=>[t(n,{size:"14"},{default:l(()=>[t(K)]),_:1})]),_:1},8,["onClick"])):v("",!0)])]),_:2},1032,["prop","label"]))),128))]),_:1},8,["data"])),[[ne,S.value]])]),_:1})):v("",!0),r.value&&!r.value.success?(d(),_(V,{key:1,shadow:"hover",style:{"border-left":"4px solid #f56c6c"}},{header:l(()=>[i("div",Le,[t(n,{color:"#f56c6c"},{default:l(()=>[t(ee)]),_:1}),e[12]||(e[12]=i("span",{style:{"font-weight":"600",color:"#f56c6c"}},"执行错误",-1))])]),default:l(()=>[i("div",Ee,g(r.value.message),1)]),_:1})):v("",!0),t(le,{modelValue:c.visible,"onUpdate:modelValue":e[4]||(e[4]=a=>c.visible=a),title:c.title,width:"600px"},{footer:l(()=>[i("div",ke,[t(x,{size:"small"},{default:l(()=>[m("长度: "+g(c.content?.length||0)+" 字符",1)]),_:1}),i("div",null,[t(u,{onClick:j},{default:l(()=>[t(n,null,{default:l(()=>[t(te)]),_:1}),e[13]||(e[13]=m(" 复制 ",-1))]),_:1}),t(u,{type:"primary",onClick:e[3]||(e[3]=a=>c.visible=!1)},{default:l(()=>[...e[14]||(e[14]=[m("关闭",-1)])]),_:1})])])]),default:l(()=>[t(q,{title:`数据类型: ${c.type}`,type:"info",closable:!1,style:{"margin-bottom":"15px"}},null,8,["title"]),t(z,{modelValue:c.content,"onUpdate:modelValue":e[2]||(e[2]=a=>c.content=a),type:"textarea",rows:15,readonly:"",style:{"font-family":"'Courier New', monospace"}},null,8,["modelValue"])]),_:1},8,["modelValue","title"])])}}},Ue=se(De,[["__scopeId","data-v-5fc69caa"]]);export{Ue as default};
